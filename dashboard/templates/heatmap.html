{% extends "base.html" %}

{% block title %}{{ page_title }} - UGC AICTE Portal{% endblock %}

{% block custom_css %}
<style>
    .heatmap-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .heatmap-header {
        background: rgba(255,255,255,0.95);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
    }
    
    .heatmap-controls {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .heatmap-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        min-height: 500px;
    }
    
    .heatmap-type-btn {
        border: 2px solid #e9ecef;
        background: white;
        color: #6c757d;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .heatmap-type-btn:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
    }
    
    .heatmap-type-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
    }
    
    .heatmap-cell {
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .heatmap-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10;
        position: relative;
    }
    
    .legend-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        gap: 20px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #6c757d;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .heatmap-canvas-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .heatmap-sidebar {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        height: fit-content;
    }
    
    .legend-section, .stats-section {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .insights-content {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        min-height: 150px;
        border: 1px solid #e9ecef;
    }
    
    .insights-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 15px;
    }
    
    .btn-group-custom {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .ai-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
<li class="breadcrumb-item active" aria-current="page">Performance Heatmap</li>
{% endblock %}

{% block content %}
<div class="heatmap-dashboard">
    <div class="container-fluid">
        <!-- Header -->
        <div class="heatmap-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3">
                        <i class="bi bi-grid-fill text-primary"></i>
                        Performance Heatmap Analysis
                    </h1>
                    <p class="lead mb-0">Interactive visualization of institutional performance across different metrics and geographical regions</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="ai-badge">
                        <i class="bi bi-robot"></i>
                        <span>AI-Powered Analytics</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="heatmap-controls">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-3">Analysis Type</h5>
                    <div class="btn-group-custom">
                        <button class="heatmap-type-btn active" data-type="state_performance">
                            <i class="bi bi-geo-alt"></i> State Performance
                        </button>
                        <button class="heatmap-type-btn" data-type="metric_correlation">
                            <i class="bi bi-diagram-3"></i> Metric Correlation
                        </button>
                        <button class="heatmap-type-btn" data-type="category_analysis">
                            <i class="bi bi-pie-chart"></i> Category Analysis
                        </button>
                        <button class="heatmap-type-btn" data-type="risk_assessment">
                            <i class="bi bi-exclamation-triangle"></i> Risk Assessment
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary" onclick="downloadHeatmapData()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Heatmap -->
        <div class="heatmap-container">
            <div id="heatmapLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading heatmap...</span>
                </div>
                <p class="mt-3 text-muted">Generating heatmap visualization...</p>
            </div>
            
            <div id="heatmapContent" class="d-none">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="heatmap-canvas-container position-relative">
                            <canvas id="heatmapCanvas" width="800" height="600" class="border rounded"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="heatmap-sidebar">
                            <div id="heatmapLegend" class="legend-section mb-4">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="bi bi-palette me-2"></i>Legend
                                </h6>
                                <!-- Legend will be populated by JavaScript -->
                            </div>
                            <div id="heatmapStats" class="stats-section">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="bi bi-graph-up me-2"></i>Statistics
                                </h6>
                                <!-- Statistics will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Panel -->
        <div class="heatmap-container">
            <div class="insights-header mb-4">
                <h5 class="fw-bold text-dark mb-2">
                    <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                    AI-Generated Insights
                </h5>
                <p class="text-muted mb-0">Intelligent analysis based on heatmap patterns</p>
            </div>
            <div id="heatmapInsights" class="insights-content">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-hourglass-split fs-2 text-primary opacity-50"></i>
                    <p class="mt-3 mb-0">AI insights will appear here after selecting a heatmap type...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentHeatmapType = 'state_performance';
let heatmapData = null;

document.addEventListener('DOMContentLoaded', function() {
    setupHeatmapControls();
    loadHeatmapData();
});

function setupHeatmapControls() {
    document.querySelectorAll('.heatmap-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.heatmap-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentHeatmapType = this.dataset.type;
            renderHeatmap();
        });
    });
}

async function loadHeatmapData() {
    try {
        const response = await fetch('/api/heatmap-data');
        const result = await response.json();
        
        if (result.success) {
            heatmapData = result.data;
            renderHeatmap();
        } else {
            showError('Failed to load heatmap data');
        }
    } catch (error) {
        console.error('Error loading heatmap data:', error);
        showError('Network error while loading heatmap data');
    }
}

function renderHeatmap() {
    if (!heatmapData) return;
    
    document.getElementById('heatmapLoading').classList.add('d-none');
    document.getElementById('heatmapContent').classList.remove('d-none');
    
    const canvas = document.getElementById('heatmapCanvas');
    const ctx = canvas.getContext('2d');
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    switch (currentHeatmapType) {
        case 'state_performance':
            renderStatePerformanceHeatmap(ctx, heatmapData.state_performance);
            break;
        case 'metric_correlation':
            renderMetricCorrelationHeatmap(ctx, heatmapData.metric_correlation);
            break;
        case 'category_analysis':
            renderCategoryAnalysisHeatmap(ctx, heatmapData.category_analysis);
            break;
        case 'risk_assessment':
            renderRiskAssessmentHeatmap(ctx, heatmapData.risk_assessment);
            break;
    }
    
    updateLegendAndStats();
}

function renderStatePerformanceHeatmap(ctx, data) {
    const cellWidth = 80;
    const cellHeight = 40;
    const cols = 8;
    
    data.forEach((state, index) => {
        const x = (index % cols) * cellWidth;
        const y = Math.floor(index / cols) * cellHeight;
        
        // Color based on performance index
        const intensity = state.performance_index / 100;
        const color = getColorFromIntensity(intensity);
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, cellWidth - 2, cellHeight - 2);
        
        // Add state label
        ctx.fillStyle = '#000';
        ctx.font = '12px Arial';
        ctx.fillText(state.state.substring(0, 8), x + 5, y + 15);
        ctx.fillText(state.performance_index.toFixed(0), x + 5, y + 30);
    });
}

function renderMetricCorrelationHeatmap(ctx, data) {
    const cellSize = 60;
    const metrics = ['NIRF_Rank', 'Placement_Percentage', 'UGC_Rating', 'Student_Faculty_Ratio', 'Research_Publications'];
    
    data.forEach(item => {
        const x = item.x * cellSize;
        const y = item.y * cellSize;
        
        const intensity = (item.correlation + 1) / 2; // Normalize to 0-1
        const color = getCorrelationColor(item.correlation);
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, cellSize - 2, cellSize - 2);
        
        // Add correlation value
        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.fillText(item.correlation.toFixed(2), x + 5, y + 30);
    });
    
    // Add axis labels
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    metrics.forEach((metric, index) => {
        ctx.fillText(metric.substring(0, 8), index * cellSize + 5, cellSize * metrics.length + 20);
        ctx.save();
        ctx.translate(0, index * cellSize + 30);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText(metric.substring(0, 8), -80, -5);
        ctx.restore();
    });
}

function renderCategoryAnalysisHeatmap(ctx, data) {
    const cellWidth = 150;
    const cellHeight = 80;
    
    data.forEach((category, index) => {
        const x = (index % 3) * cellWidth;
        const y = Math.floor(index / 3) * cellHeight;
        
        const intensity = category.excellence_score / 100;
        const color = getColorFromIntensity(intensity);
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, cellWidth - 2, cellHeight - 2);
        
        // Add category info
        ctx.fillStyle = '#000';
        ctx.font = '14px Arial';
        ctx.fillText(category.category, x + 10, y + 20);
        ctx.font = '12px Arial';
        ctx.fillText(`Score: ${category.excellence_score.toFixed(1)}`, x + 10, y + 40);
        ctx.fillText(`Count: ${category.count}`, x + 10, y + 60);
    });
}

function renderRiskAssessmentHeatmap(ctx, data) {
    const cellWidth = 100;
    const cellHeight = 60;
    const cols = 8;
    
    data.slice(0, 40).forEach((college, index) => {
        const x = (index % cols) * cellWidth;
        const y = Math.floor(index / cols) * cellHeight;
        
        // Color based on risk level
        const color = getRiskColor(college.risk_level);
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, cellWidth - 2, cellHeight - 2);
        
        // Add college info
        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.fillText(college.college_name.substring(0, 12), x + 5, y + 15);
        ctx.fillText(college.risk_category, x + 5, y + 30);
        ctx.fillText(`Risk: ${college.risk_level}`, x + 5, y + 45);
    });
}

function getColorFromIntensity(intensity) {
    const r = Math.floor(255 * (1 - intensity));
    const g = Math.floor(255 * intensity);
    return `rgb(${r}, ${g}, 100)`;
}

function getCorrelationColor(correlation) {
    if (correlation > 0.5) return '#4CAF50'; // Green for positive correlation
    if (correlation < -0.5) return '#F44336'; // Red for negative correlation
    return '#FFC107'; // Yellow for low correlation
}

function getRiskColor(riskLevel) {
    switch (riskLevel) {
        case 0:
        case 1: return '#4CAF50'; // Low risk - Green
        case 2: return '#FFC107'; // Medium risk - Yellow
        case 3:
        case 4: return '#F44336'; // High risk - Red
        default: return '#9E9E9E'; // Unknown - Gray
    }
}

function updateLegendAndStats() {
    const legendContainer = document.getElementById('heatmapLegend');
    const statsContainer = document.getElementById('heatmapStats');
    
    // Update legend based on current heatmap type
    let legendHTML = '<h6>Legend</h6>';
    let statsHTML = '<h6>Statistics</h6>';
    
    switch (currentHeatmapType) {
        case 'state_performance':
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>High Performance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFC107;"></div>
                    <span>Medium Performance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span>Low Performance</span>
                </div>
            `;
            
            if (heatmapData.state_performance) {
                const avgPerformance = heatmapData.state_performance.reduce((sum, state) => sum + state.performance_index, 0) / heatmapData.state_performance.length;
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${heatmapData.state_performance.length}</div>
                        <div class="stat-label">States Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgPerformance.toFixed(1)}</div>
                        <div class="stat-label">Avg Performance</div>
                    </div>
                `;
            }
            break;
            
        case 'risk_assessment':
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>Low Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFC107;"></div>
                    <span>Medium Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span>High Risk</span>
                </div>
            `;
            
            if (heatmapData.risk_assessment) {
                const highRisk = heatmapData.risk_assessment.filter(c => c.risk_level >= 3).length;
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${highRisk}</div>
                        <div class="stat-label">High Risk Institutions</div>
                    </div>
                `;
            }
            break;
    }
    
    legendContainer.innerHTML = legendHTML;
    statsContainer.innerHTML = statsHTML;
}

function downloadHeatmapData() {
    if (!heatmapData) return;
    
    const dataStr = JSON.stringify(heatmapData[currentHeatmapType], null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `heatmap_${currentHeatmapType}_data.json`;
    link.click();
    
    URL.revokeObjectURL(url);
}

function showError(message) {
    document.getElementById('heatmapContent').innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i>
            ${message}
        </div>
    `;
}
</script>
{% endblock %}