{% extends "base.html" %}

{% block title %}{{ page_title }} - UGC AICTE Portal{% endblock %}

{% block custom_css %}
<style>
    .trends-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .technical-header {
        background: rgba(255,255,255,0.95);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
    }
    
    .analysis-controls {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        min-height: 400px;
    }
    
    .ai-insights-panel {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        color: white;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .technical-metrics {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin: 10px;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-value {
        font-size: 2.5em;
        font-weight: bold;
        line-height: 1;
    }
    
    .metric-label {
        font-size: 0.9em;
        margin-top: 10px;
        opacity: 0.9;
    }
    
    .chart-selector {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .analysis-type-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .analysis-type-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .analysis-type-btn.active {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 15px;
        z-index: 1000;
    }
    
    .spinner-technical {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .ai-response {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
        border-left: 4px solid #00f2fe;
        backdrop-filter: blur(10px);
    }
    
    .technical-indicator {
        display: inline-block;
        background: rgba(255,255,255,0.2);
        padding: 5px 12px;
        border-radius: 20px;
        margin: 5px;
        font-size: 0.85em;
        backdrop-filter: blur(10px);
    }
    
    .prediction-panel {
        background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
        border-radius: 15px;
        padding: 25px;
        color: white;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.4em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
    }
    
    .metric-prediction {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .metric-prediction:last-child {
        border-bottom: none;
    }
    
    .btn-analyze {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-analyze:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        color: white;
    }
    
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .insight-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .insight-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 1.5em;
    }
    
    .icon-trend { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .icon-prediction { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .icon-recommendation { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    
    .empty-state-trends {
        text-align: center;
        padding: 80px 20px;
        color: #6c757d;
    }
    
    .empty-state-trends i {
        font-size: 5rem;
        margin-bottom: 20px;
        color: #dee2e6;
    }
    
    .loading-trends {
        display: none;
        text-align: center;
        padding: 60px;
    }
    
    .loading-trends .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .years-selector {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
    }
    
    .years-btn {
        padding: 8px 16px;
        border: 2px solid rgba(255,255,255,0.3);
        background: transparent;
        color: white;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .years-btn.active {
        background: rgba(255,255,255,0.2);
        border-color: white;
    }
    
    .years-btn:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="trends-dashboard">
    <div class="container-fluid">
        <!-- Technical Header -->
        <div class="technical-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3">
                        <i class="bi bi-graph-up"></i>
                        Advanced Institutional Trends Analysis
                    </h1>
                    <p class="lead mb-0">
                        Comprehensive AI-Powered Analytics for Higher Education Performance Assessment
                        <br><small class="text-muted">Statistical Modeling ‚Ä¢ Predictive Analytics ‚Ä¢ Technical Visualization</small>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-primary fs-6 p-3">
                        <i class="bi bi-robot"></i> Gemini AI Enhanced
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Controls -->
        <div class="analysis-controls">
            <div class="row">
                <div class="col-md-6">
                    <h5>Analysis Configuration</h5>
                    <div class="chart-selector">
                        <label class="form-label">Chart Type Selection:</label>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="analysis-type-btn active" data-chart="comprehensive_dashboard">
                                üìä Comprehensive Performance Dashboard
                            </button>
                            <button type="button" class="analysis-type-btn" data-chart="research_excellence">
                                üî¨ Research Excellence Analysis
                            </button>
                            <button type="button" class="analysis-type-btn" data-chart="enrollment_dynamics">
                                üë• Enrollment Dynamics & Trends
                            </button>
                            <button type="button" class="analysis-type-btn" data-chart="regional_performance">
                                üó∫Ô∏è Regional Performance Mapping
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Predictive Parameters</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Forecast Years:</label>
                            <select class="form-select" id="forecastYears">
                                <option value="3">3 Years</option>
                                <option value="5" selected>5 Years</option>
                                <option value="10">10 Years</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confidence Level:</label>
                            <select class="form-select" id="confidenceLevel">
                                <option value="90">90%</option>
                                <option value="95" selected>95%</option>
                                <option value="99">99%</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mt-3" onclick="generateAnalysis()">
                        <i class="bi bi-cpu"></i> Generate AI Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Technical Metrics Overview -->
        <div class="technical-metrics">
            <h5 class="mb-3">Real-time Data Quality Indicators</h5>
            <div class="row" id="technicalMetrics">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="dataQuality">--</div>
                        <div class="metric-label">Data Quality Score</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="temporalCoverage">--</div>
                        <div class="metric-label">Temporal Coverage</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="sampleSize">--</div>
                        <div class="metric-label">Sample Size</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="confidenceIndex">--</div>
                        <div class="metric-label">Confidence Index</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Chart Area -->
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="loading-overlay" id="chartLoading" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-technical"></div>
                            <p class="mt-3">Generating Advanced Analytics...</p>
                        </div>
                    </div>
                    <div class="chart-title" id="chartTitle">
                        üìä Comprehensive Performance Dashboard
                    </div>
                    <canvas id="mainChart" width="100%" height="400"></canvas>
                </div>

                <!-- Secondary Charts Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">üìà Trend Analysis</div>
                            <canvas id="trendChart" width="100%" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">üéØ Performance Distribution</div>
                            <canvas id="distributionChart" width="100%" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Panel -->
            <div class="col-lg-4">
                <div class="ai-insights-panel">
                    <h5>ü§ñ Gemini AI Technical Insights</h5>
                    <div id="aiInsights">
                        <p>Click "Generate AI Analysis" to get comprehensive technical insights powered by Google Gemini AI.</p>
                    </div>
                </div>

                <!-- Predictive Models -->
                <div class="prediction-panel">
                    <h5>üîÆ Predictive Forecasting</h5>
                    <div id="predictiveInsights">
                        <p>Advanced statistical models and machine learning predictions will appear here.</p>
                    </div>
                </div>

                <!-- Technical Statistics -->
                <div class="technical-metrics">
                    <h5>üìä Statistical Summary</h5>
                    <div id="statisticalSummary">
                        <p>Detailed statistical analysis including correlation coefficients, regression analysis, and significance testing.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                        Trend Insights
                    </h1>
                    <p class="text-muted">Analyze historical performance trends and predict future outcomes</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        Data Coverage: 2019-2023
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Institution Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="institution-selector-trends">
                <h4 class="mb-3">
                    <i class="bi bi-search me-2"></i>
                    Select Institution for Trend Analysis
                </h4>
                <p class="mb-4">Choose an institution to analyze its historical performance trends and future predictions</p>
                
                <div class="row align-items-end">
                    <div class="col-lg-6">
                        <label class="form-label">Institution</label>
                        <select id="institutionSelectTrends" class="form-select form-select-lg">
                            <option value="">Select an institution...</option>
                            {% for college in colleges %}
                            <option value="{{ college.name }}">{{ college.name }} ({{ college.state }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <label class="form-label">Prediction Period</label>
                        <div class="years-selector">
                            <button type="button" class="years-btn active" data-years="3">3 Years</button>
                            <button type="button" class="years-btn" data-years="5">5 Years</button>
                            <button type="button" class="years-btn" data-years="7">7 Years</button>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <button id="analyzeTrendsBtn" class="btn btn-analyze btn-lg w-100" disabled>
                            <i class="bi bi-graph-up me-2"></i>
                            Analyze Trends
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingTrends" class="loading-trends">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Analyzing trends...</span>
        </div>
        <p class="mt-3">Analyzing historical data and generating predictions...</p>
    </div>

    <!-- Trend Analysis Results -->
    <div id="trendsResults" style="display: none;">
        <!-- Overview Insights -->
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-icon icon-trend">
                    <i class="bi bi-trending-up"></i>
                </div>
                <h6>Overall Trend</h6>
                <span id="overallTrend" class="trend-indicator trend-stable">Stable</span>
            </div>
            <div class="insight-card">
                <div class="insight-icon icon-prediction">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <h6>Prediction Confidence</h6>
                <span id="predictionConfidence" class="confidence-badge confidence-medium">Medium</span>
            </div>
            <div class="insight-card">
                <div class="insight-icon icon-recommendation">
                    <i class="bi bi-lightbulb"></i>
                </div>
                <h6>Key Recommendation</h6>
                <p id="keyRecommendation" class="mb-0 mt-2">Analysis in progress...</p>
            </div>
        </div>

        <!-- Historical Trends Charts -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="trends-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-down text-info"></i>
                            Performance Index Trend
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="trend-chart-container">
                            <canvas id="performanceTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="trends-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart text-success"></i>
                            Placement Rate Trend
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="trend-chart-container">
                            <canvas id="placementTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Trends -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="trends-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity text-warning"></i>
                            All Metrics Historical Trends
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="trend-chart-container">
                            <canvas id="allMetricsTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Predictions Panel -->
        <div id="predictionsPanel" class="prediction-panel">
            <h4 class="mb-3">
                <i class="bi bi-crystal-ball me-2"></i>
                Future Predictions
            </h4>
            <div id="predictionsContent">
                <!-- Predictions will be populated dynamically -->
            </div>
        </div>

        <!-- Recommendations Panel -->
        <div class="row">
            <div class="col-12">
                <div class="trends-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check text-primary"></i>
                            Strategic Recommendations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendationsContent">
                            <!-- Recommendations will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyStateTrends" class="empty-state-trends">
        <i class="bi bi-graph-up-arrow"></i>
        <h4>Ready for Trend Analysis</h4>
        <p>Select an institution from the dropdown above to analyze historical trends and generate future predictions.</p>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
let mainChart, trendChart, distributionChart;
let currentChartType = 'comprehensive_dashboard';
let analysisData = null;

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    loadInitialData();
});

function setupEventListeners() {
    // Chart type selection
    document.querySelectorAll('.analysis-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.analysis-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentChartType = this.dataset.chart;
            updateChartTitle();
            generateAdvancedCharts();
        });
    });
}

function updateChartTitle() {
    const titles = {
        'comprehensive_dashboard': 'üìä Comprehensive Performance Dashboard',
        'research_excellence': 'üî¨ Research Excellence Analysis',
        'enrollment_dynamics': 'üë• Enrollment Dynamics & Trends',
        'regional_performance': 'üó∫Ô∏è Regional Performance Mapping'
    };
    document.getElementById('chartTitle').textContent = titles[currentChartType];
}

function initializeCharts() {
    // Main Chart
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(mainCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Institutional Performance Trends'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Performance Metrics'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Academic Year'
                    }
                }
            }
        }
    });

    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Growth Rate Analysis'
                }
            }
        }
    });

    // Distribution Chart
    const distCtx = document.getElementById('distributionChart').getContext('2d');
    distributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Performance Distribution'
                }
            }
        }
    });
}

function loadInitialData() {
    showLoading(true);
    generateAdvancedCharts();
}

function showLoading(show) {
    const loadingElement = document.getElementById('chartLoading');
    if (loadingElement) {
        loadingElement.style.display = show ? 'flex' : 'none';
    }
}

async function generateAnalysis() {
    showLoading(true);
    
    try {
        // Generate trend analysis
        const trendResponse = await fetch('/api/trends', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'comprehensive',
                years_to_predict: parseInt(document.getElementById('forecastYears').value)
            })
        });

        if (trendResponse.ok) {
            const trendData = await trendResponse.json();
            if (trendData.success) {
                analysisData = trendData.results;
                updateTechnicalMetrics(trendData.results);
                updateAIInsights(trendData.results.ai_insights);
                updatePredictiveInsights(trendData.results.predictive_models);
                updateStatisticalSummary(trendData.results.statistical_insights);
            }
        }

        // Generate advanced charts
        await generateAdvancedCharts();
        
    } catch (error) {
        console.error('Error generating analysis:', error);
        document.getElementById('aiInsights').innerHTML = 
            '<div class="alert alert-danger">Error generating analysis. Please try again.</div>';
    } finally {
        showLoading(false);
    }
}

async function generateAdvancedCharts() {
    try {
        const chartResponse = await fetch('/api/trends/advanced-charts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chart_type: currentChartType,
                parameters: {
                    confidence_level: parseFloat(document.getElementById('confidenceLevel').value)
                }
            })
        });

        if (chartResponse.ok) {
            const chartData = await chartResponse.json();
            if (chartData.success) {
                updateCharts(chartData.data);
                if (chartData.data.ai_insights) {
                    updateChartInsights(chartData.data.ai_insights);
                }
            }
        }
    } catch (error) {
        console.error('Error generating charts:', error);
    }
}

function updateCharts(data) {
    switch (currentChartType) {
        case 'comprehensive_dashboard':
            updateComprehensiveDashboard(data);
            break;
        case 'research_excellence':
            updateResearchCharts(data);
            break;
        case 'enrollment_dynamics':
            updateEnrollmentCharts(data);
            break;
        case 'regional_performance':
            updateRegionalCharts(data);
            break;
    }
    
    updateTechnicalIndicators(data.technical_indicators);
}

function updateComprehensiveDashboard(data) {
    if (data.performance_timeline) {
        const years = data.performance_timeline.map(d => d.year);
        const rankings = data.performance_timeline.map(d => d.avg_ranking);
        const students = data.performance_timeline.map(d => d.total_students);
        const publications = data.performance_timeline.map(d => d.total_publications);
        
        mainChart.data.labels = years;
        mainChart.data.datasets = [
            {
                label: 'Average NIRF Ranking',
                data: rankings,
                borderColor: 'rgba(102, 126, 234, 1)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                yAxisID: 'y'
            },
            {
                label: 'Total Students (thousands)',
                data: students.map(s => s / 1000),
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                yAxisID: 'y1'
            }
        ];
        mainChart.options.scales.y1 = {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
                drawOnChartArea: false,
            },
            title: {
                display: true,
                text: 'Student Enrollment (thousands)'
            }
        };
        mainChart.update();
        
        // Update trend chart with publications
        trendChart.data.labels = years;
        trendChart.data.datasets = [{
            label: 'Research Publications',
            data: publications,
            backgroundColor: 'rgba(75, 192, 192, 0.8)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }];
        trendChart.update();
    }
}

function updateResearchCharts(data) {
    if (data.research_trends) {
        // Update with research-specific visualizations
        const researchData = data.research_trends;
        // Implementation for research excellence charts
    }
}

function updateEnrollmentCharts(data) {
    if (data.enrollment_composition) {
        // Update with enrollment-specific visualizations
        const enrollmentData = data.enrollment_composition;
        // Implementation for enrollment dynamics charts
    }
}

function updateRegionalCharts(data) {
    if (data.state_performance) {
        // Update with regional performance visualizations
        const regionalData = data.state_performance;
        // Implementation for regional performance charts
    }
}

function updateTechnicalMetrics(results) {
    if (results.quality_indicators) {
        const quality = results.quality_indicators.overall_data_quality;
        document.getElementById('dataQuality').textContent = quality.completeness.toFixed(1) + '%';
        document.getElementById('temporalCoverage').textContent = `${quality.years_covered} Years`;
        document.getElementById('sampleSize').textContent = quality.total_institutions.toLocaleString();
        document.getElementById('confidenceIndex').textContent = quality.data_consistency_score.toFixed(1) + '%';
    }
}

function updateTechnicalIndicators(indicators) {
    if (indicators) {
        document.getElementById('dataQuality').textContent = indicators.data_quality_score.toFixed(1) + '%';
        document.getElementById('confidenceIndex').textContent = indicators.trend_confidence.toFixed(1) + '%';
    }
}

function updateAIInsights(insights) {
    const insightsElement = document.getElementById('aiInsights');
    if (insights && insights.comprehensive_analysis) {
        insightsElement.innerHTML = `
            <div class="ai-response">
                <h6><i class="bi bi-robot"></i> AI Technical Analysis</h6>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${insights.comprehensive_analysis.replace(/\n/g, '<br>')}
                </div>
                <div class="mt-3">
                    <span class="technical-indicator">Confidence: ${insights.confidence_level}</span>
                    <span class="technical-indicator">Generated: ${new Date(insights.analysis_timestamp).toLocaleString()}</span>
                </div>
            </div>
        `;
    }
}

function updatePredictiveInsights(models) {
    const predictiveElement = document.getElementById('predictiveInsights');
    if (models) {
        let html = '<div class="row">';
        Object.keys(models).forEach(metric => {
            const model = models[metric];
            html += `
                <div class="col-12 mb-3">
                    <h6>${metric.replace(/_/g, ' ').toUpperCase()}</h6>
                    <p class="small">Future predictions: ${model.predicted_values.slice(0, 3).map(v => v.toFixed(0)).join(', ')}</p>
                </div>
            `;
        });
        html += '</div>';
        predictiveElement.innerHTML = html;
    }
}

function updateStatisticalSummary(insights) {
    const summaryElement = document.getElementById('statisticalSummary');
    if (insights) {
        let html = '<div class="small">';
        Object.keys(insights).forEach(metric => {
            const stat = insights[metric];
            html += `
                <div class="mb-2">
                    <strong>${metric.replace(/_/g, ' ')}:</strong><br>
                    R¬≤ = ${stat.r_squared?.toFixed(3) || 'N/A'} | 
                    Trend: ${stat.trend_direction || 'N/A'} | 
                    Growth Rate: ${stat.yearly_growth_rate?.toFixed(2) || 'N/A'}%
                </div>
            `;
        });
        html += '</div>';
        summaryElement.innerHTML = html;
    }
}

function updateChartInsights(insights) {
    if (insights && insights.technical_commentary) {
        const existingInsights = document.getElementById('aiInsights').innerHTML;
        document.getElementById('aiInsights').innerHTML = existingInsights + `
            <div class="ai-response mt-3">
                <h6><i class="bi bi-graph-up"></i> Chart Technical Commentary</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${insights.technical_commentary.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    }
}
</script>

// Global variables
let trendsData = null;
let performanceTrendChart = null;
let placementTrendChart = null;
let allMetricsTrendChart = null;
let selectedYears = 3;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    // Institution selection
    document.getElementById('institutionSelectTrends').addEventListener('change', function() {
        const analyzeBtn = document.getElementById('analyzeTrendsBtn');
        analyzeBtn.disabled = !this.value;
    });
    
    // Years selection
    document.querySelectorAll('.years-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.years-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedYears = parseInt(this.dataset.years);
        });
    });
    
    // Analyze button
    document.getElementById('analyzeTrendsBtn').addEventListener('click', performTrendAnalysis);
}

async function performTrendAnalysis() {
    const selectedInstitution = document.getElementById('institutionSelectTrends').value;
    
    if (!selectedInstitution) {
        alert('Please select an institution for analysis.');
        return;
    }
    
    showLoadingTrends(true);
    hideResults();
    
    try {
        const response = await fetch('/api/trends', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                institution: selectedInstitution,
                years_to_predict: selectedYears
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            trendsData = data;
            displayTrendResults(data);
        } else {
            throw new Error(data.error || 'Failed to get trend analysis');
        }
        
    } catch (error) {
        console.error('Trend analysis error:', error);
        alert('Error performing trend analysis: ' + error.message);
    } finally {
        showLoadingTrends(false);
    }
}

function showLoadingTrends(show) {
    document.getElementById('loadingTrends').style.display = show ? 'block' : 'none';
}

function hideResults() {
    document.getElementById('trendsResults').style.display = 'none';
    document.getElementById('emptyStateTrends').style.display = 'block';
}

function displayTrendResults(data) {
    document.getElementById('emptyStateTrends').style.display = 'none';
    document.getElementById('trendsResults').style.display = 'block';
    
    displayOverviewInsights(data.insights);
    createTrendCharts(data.historical_data, data.predictions);
    displayPredictions(data.predictions);
    displayRecommendations(data.insights.recommendations);
}

function displayOverviewInsights(insights) {
    // Overall trend
    const overallTrendEl = document.getElementById('overallTrend');
    overallTrendEl.textContent = insights.overall_trend.charAt(0).toUpperCase() + insights.overall_trend.slice(1);
    overallTrendEl.className = `trend-indicator trend-${insights.overall_trend}`;
    
    // Prediction confidence
    const confidenceEl = document.getElementById('predictionConfidence');
    confidenceEl.textContent = insights.prediction_confidence.charAt(0).toUpperCase() + insights.prediction_confidence.slice(1);
    confidenceEl.className = `confidence-badge confidence-${insights.prediction_confidence}`;
    
    // Key recommendation
    const recommendationEl = document.getElementById('keyRecommendation');
    recommendationEl.textContent = insights.recommendations.length > 0 ? 
        insights.recommendations[0] : 'Continue maintaining current performance standards';
}

function createTrendCharts(historicalData, predictions) {
    createPerformanceTrendChart(historicalData, predictions);
    createPlacementTrendChart(historicalData, predictions);
    createAllMetricsTrendChart(historicalData);
}

function createPerformanceTrendChart(historicalData, predictions) {
    const ctx = document.getElementById('performanceTrendChart').getContext('2d');
    
    if (performanceTrendChart) {
        performanceTrendChart.destroy();
    }
    
    const performanceData = historicalData['Final_Performance_Index'];
    const performancePredictions = predictions['Final_Performance_Index'];
    
    let datasets = [];
    
    // Historical data
    if (performanceData) {
        datasets.push({
            label: 'Historical Performance',
            data: performanceData.years.map((year, index) => ({
                x: year,
                y: performanceData.values[index]
            })),
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            fill: true,
            tension: 0.4
        });
    }
    
    // Predictions
    if (performancePredictions) {
        datasets.push({
            label: 'Predicted Performance',
            data: performancePredictions.years.map((year, index) => ({
                x: year,
                y: performancePredictions.values[index]
            })),
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderDash: [5, 5],
            fill: false,
            tension: 0.4
        });
    }
    
    performanceTrendChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Performance Index'
                    },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function createPlacementTrendChart(historicalData, predictions) {
    const ctx = document.getElementById('placementTrendChart').getContext('2d');
    
    if (placementTrendChart) {
        placementTrendChart.destroy();
    }
    
    const placementData = historicalData['Placement_Percentage'];
    const placementPredictions = predictions['Placement_Percentage'];
    
    let datasets = [];
    
    // Historical data
    if (placementData) {
        datasets.push({
            label: 'Historical Placement Rate',
            data: placementData.years.map((year, index) => ({
                x: year,
                y: placementData.values[index]
            })),
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            fill: true,
            tension: 0.4
        });
    }
    
    // Predictions
    if (placementPredictions) {
        datasets.push({
            label: 'Predicted Placement Rate',
            data: placementPredictions.years.map((year, index) => ({
                x: year,
                y: placementPredictions.values[index]
            })),
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            borderDash: [5, 5],
            fill: false,
            tension: 0.4
        });
    }
    
    placementTrendChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Placement Percentage (%)'
                    },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function createAllMetricsTrendChart(historicalData) {
    const ctx = document.getElementById('allMetricsTrendChart').getContext('2d');
    
    if (allMetricsTrendChart) {
        allMetricsTrendChart.destroy();
    }
    
    const metrics = ['AICTE_Approval_Score', 'UGC_Rating', 'Infrastructure_Score', 'Student_Satisfaction_Score'];
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545'];
    
    let datasets = [];
    
    metrics.forEach((metric, index) => {
        const metricData = historicalData[metric];
        if (metricData) {
            datasets.push({
                label: metric.replace(/_/g, ' '),
                data: metricData.years.map((year, idx) => ({
                    x: year,
                    y: metricData.values[idx]
                })),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                fill: false,
                tension: 0.4
            });
        }
    });
    
    allMetricsTrendChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Score'
                    },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function displayPredictions(predictions) {
    const predictionsContent = document.getElementById('predictionsContent');
    let html = '';
    
    Object.keys(predictions).forEach(metric => {
        const predData = predictions[metric];
        const metricName = metric.replace(/_/g, ' ');
        const latestValue = predData.values[predData.values.length - 1];
        const confidence = (predData.confidence * 100).toFixed(0);
        
        html += `
            <div class="prediction-item">
                <div class="metric-prediction">
                    <div>
                        <strong>${metricName}</strong>
                        <br>
                        <small>Predicted for ${predData.years[predData.years.length - 1]}</small>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">${latestValue.toFixed(1)}</h5>
                        <small>Confidence: ${confidence}%</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    predictionsContent.innerHTML = html;
}

function displayRecommendations(recommendations) {
    const recommendationsContent = document.getElementById('recommendationsContent');
    
    if (recommendations.length === 0) {
        recommendationsContent.innerHTML = '<p class="text-muted">No specific recommendations at this time. Continue monitoring performance metrics.</p>';
        return;
    }
    
    let html = '<ul class="list-group list-group-flush">';
    recommendations.forEach(rec => {
        html += `<li class="list-group-item"><i class="bi bi-check-circle text-success me-2"></i>${rec}</li>`;
    });
    html += '</ul>';
    
    recommendationsContent.innerHTML = html;
}
</script>
{% endblock %}