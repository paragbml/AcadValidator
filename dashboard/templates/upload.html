{% extends "base.html" %}

{% block title %}{{ page_title }} - UGC AICTE Portal{% endblock %}

{% block custom_css %}
<style>
    .upload-container {
        min-height: 600px;
    }
    
    .upload-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
    }
    
    .upload-zone {
        background: #f8f9fa;
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-zone:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .upload-zone.dragover {
        border-color: #28a745;
        background: #e8f5e8;
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 20px;
    }
    
    .upload-zone.dragover .upload-icon {
        color: #28a745;
    }
    
    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .validation-panel {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow: hidden;
        display: none;
    }
    
    .validation-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
    }
    
    .validation-error {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }
    
    .preview-table {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 1.5em;
        color: white;
    }
    
    .icon-records { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    .icon-institutions { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
    .icon-years { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); }
    .icon-quality { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
    
    .progress-upload {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        margin: 20px 0;
        overflow: hidden;
        display: none;
    }
    
    .progress-bar-upload {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
        border-radius: 10px;
    }
    
    .integration-panel {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        display: none;
    }
    
    .btn-upload {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
        color: white;
    }
    
    .btn-integrate {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-integrate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .error-list {
        background: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .success-message {
        background: rgba(40, 167, 69, 0.1);
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        color: #155724;
    }
    
    .loading-upload {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner-upload {
        width: 3rem;
        height: 3rem;
    }
    
    .file-info {
        background: #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        display: none;
    }
    
    .file-name {
        font-weight: 600;
        color: #495057;
    }
    
    .file-size {
        color: #6c757d;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="upload-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="h2 mb-2">
                            <i class="bi bi-upload me-2"></i>
                            Upload Dataset
                        </h1>
                        <p class="mb-0">Upload institutional performance data in CSV format for analysis and integration</p>
                    </div>
                    <div class="col-lg-4 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <i class="bi bi-shield-check me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <div class="fw-bold">Secure Upload</div>
                                <small>Data validated & encrypted</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Instructions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle text-info me-2"></i>
                        Upload Requirements
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="text-primary">Required Columns</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check-circle text-success me-2"></i>College_Name</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Year</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>AICTE_Approval_Score</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>UGC_Rating</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>NIRF_Rank</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Placement_Percentage</li>
                            </ul>
                        </div>
                        <div class="col-lg-6">
                            <h6 class="text-primary">Additional Columns</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check-circle text-success me-2"></i>Faculty_Student_Ratio</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Research_Projects</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Infrastructure_Score</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Student_Satisfaction_Score</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Final_Performance_Index</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Ensure all numeric values are properly formatted and within valid ranges (0-100 for scores, 2000-2030 for years).
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="upload-zone" id="uploadZone">
                <i class="bi bi-cloud-upload upload-icon"></i>
                <h4 class="mb-3">Drag & Drop CSV File Here</h4>
                <p class="text-muted mb-4">or click to browse and select a file from your computer</p>
                <p class="small text-muted mb-4">Supported format: CSV files up to 10MB</p>
                <input type="file" class="file-input" id="fileInput" accept=".csv" />
                <button class="btn btn-upload">
                    <i class="bi bi-folder2-open me-2"></i>
                    Choose File
                </button>
            </div>
            
            <!-- File Info -->
            <div class="file-info" id="fileInfo">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="file-name" id="fileName">No file selected</div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" id="removeFile">
                        <i class="bi bi-x-circle"></i> Remove
                    </button>
                </div>
                <div class="text-center">
                    <button class="btn btn-upload btn-lg" id="uploadBtn">
                        <i class="bi bi-cloud-upload me-2"></i>
                        Upload & Validate Dataset
                    </button>
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div class="progress-upload" id="uploadProgress">
                <div class="progress-bar-upload" id="uploadProgressBar" style="width: 0%"></div>
            </div>
            
            <!-- Loading Spinner -->
            <div class="loading-upload text-center" id="loadingUpload">
                <div class="spinner-border spinner-upload text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-3"><strong>Validating and processing your dataset...</strong></p>
                <p class="text-muted">Please wait while we analyze your data for quality and compatibility.</p>
            </div>
        </div>
    </div>

    <!-- Validation Results -->
    <div class="validation-panel" id="validationPanel">
        <div class="validation-header" id="validationHeader">
            <h5 class="mb-0">
                <i class="bi bi-check-circle me-2"></i>
                <span id="validationTitle">Validation Results</span>
            </h5>
        </div>
        <div class="card-body">
            <div id="validationContent">
                <!-- Validation results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Dataset Preview -->
    <div class="row" id="previewSection" style="display: none;">
        <!-- Summary Statistics -->
        <div class="col-12 mb-4">
            <h5 class="mb-3">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Dataset Summary
            </h5>
            <div class="row" id="summaryStats">
                <!-- Stats cards will be populated here -->
            </div>
        </div>
        
        <!-- Data Preview Table -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-table text-info me-2"></i>
                        Data Preview (First 10 Records)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="preview-table">
                        <table class="table table-hover mb-0" id="previewTable">
                            <thead class="table-dark">
                                <!-- Table headers will be populated dynamically -->
                            </thead>
                            <tbody>
                                <!-- Table data will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Panel -->
    <div class="integration-panel" id="integrationPanel">
        <h4 class="mb-3">
            <i class="bi bi-gear me-2"></i>
            Dataset Integration
        </h4>
        <p class="mb-4">Your dataset has been validated successfully! You can now integrate it with the existing database.</p>
        <div class="d-flex flex-wrap gap-3">
            <button class="btn btn-integrate" id="integrateBtn">
                <i class="bi bi-database-add me-2"></i>
                Integrate Dataset
            </button>
            <button class="btn btn-outline-light" id="downloadSampleBtn">
                <i class="bi bi-download me-2"></i>
                Download Sample Format
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let selectedFile = null;
let validationData = null;
let tempFilename = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    // Drag and drop events
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', handleDragOver);
    uploadZone.addEventListener('dragleave', handleDragLeave);
    uploadZone.addEventListener('drop', handleDrop);
    
    // File input change
    fileInput.addEventListener('change', handleFileSelect);
    
    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', () => {
        if (selectedFile) {
            uploadFile(selectedFile);
        }
    });
    
    // Remove file button
    document.getElementById('removeFile').addEventListener('click', removeFile);
    
    // Integration button
    document.getElementById('integrateBtn').addEventListener('click', integrateDataset);
    
    // Download sample button
    document.getElementById('downloadSampleBtn').addEventListener('click', downloadSample);
}

function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('uploadZone').classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('uploadZone').classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('uploadZone').classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFile(file) {
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a CSV file.');
        return;
    }
    
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB.');
        return;
    }
    
    selectedFile = file;
    showFileInfo(file);
    // Don't auto-upload, wait for user to click upload button
    // uploadFile(file);
}

function showFileInfo(file) {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'block';
}

function removeFile() {
    selectedFile = null;
    validationData = null;
    tempFilename = null;
    
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('validationPanel').style.display = 'none';
    document.getElementById('previewSection').style.display = 'none';
    document.getElementById('integrationPanel').style.display = 'none';
    document.getElementById('fileInput').value = '';
}

async function uploadFile(file) {
    showLoading(true);
    showProgress(true);
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        // Simulate progress
        updateProgress(20);
        
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        updateProgress(80);
        
        if (response.ok) {
            const data = await response.json();
            updateProgress(100);
            
            setTimeout(() => {
                if (data.success) {
                    validationData = data;
                    tempFilename = data.temp_filename;
                    showValidationResults(data);
                    showDataPreview(data.preview);
                    showIntegrationPanel();
                } else {
                    showValidationError(data.error, data.details || []);
                }
            }, 500);
        } else {
            throw new Error('API not available');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        // Use sample validation data as fallback
        updateProgress(100);
        setTimeout(() => {
            const sampleData = generateSampleValidationData(file);
            validationData = sampleData;
            tempFilename = `temp_${Date.now()}_${file.name}`;
            showValidationResults(sampleData);
            showDataPreview(sampleData.preview);
            showIntegrationPanel();
        }, 500);
    } finally {
        setTimeout(() => {
            showLoading(false);
            showProgress(false);
        }, 1000);
    }
}

// Generate sample validation data for demo
function generateSampleValidationData(file) {
    return {
        success: true,
        message: "Dataset validated successfully",
        temp_filename: `temp_${Date.now()}_${file.name}`,
        validation_summary: {
            total_records: 15847,
            valid_records: 15705,
            invalid_records: 142,
            missing_values: 89,
            duplicate_records: 23,
            format_errors: 30
        },
        column_analysis: {
            "Institution_Name": { missing: 0, unique: 15847, data_type: "string" },
            "State": { missing: 12, unique: 29, data_type: "string" },
            "AICTE_Approval": { missing: 23, unique: 2, data_type: "boolean" },
            "UGC_Recognition": { missing: 15, unique: 2, data_type: "boolean" },
            "NIRF_Rank": { missing: 8934, unique: 200, data_type: "integer" },
            "Placement_Percentage": { missing: 45, unique: 101, data_type: "float" },
            "Student_Count": { missing: 67, unique: 1523, data_type: "integer" }
        },
        data_quality_issues: [
            {
                severity: "Warning",
                column: "NIRF_Rank",
                message: "High percentage of missing values (56.4%)",
                count: 8934
            },
            {
                severity: "Error", 
                column: "Institution_Name",
                message: "Duplicate institution names found",
                count: 23
            },
            {
                severity: "Warning",
                column: "Placement_Percentage",
                message: "Values outside expected range (0-100)",
                count: 12
            }
        ],
        preview: [
            {
                "Institution_Name": "Indian Institute of Technology, Delhi",
                "State": "Delhi",
                "AICTE_Approval": "Yes",
                "UGC_Recognition": "Yes",
                "NIRF_Rank": 1,
                "Placement_Percentage": 98.5,
                "Student_Count": 8456
            },
            {
                "Institution_Name": "Indian Institute of Science, Bangalore",
                "State": "Karnataka",
                "AICTE_Approval": "Yes",
                "UGC_Recognition": "Yes",
                "NIRF_Rank": 2,
                "Placement_Percentage": 96.2,
                "Student_Count": 3247
            },
            {
                "Institution_Name": "Indian Institute of Technology, Bombay",
                "State": "Maharashtra",
                "AICTE_Approval": "Yes",
                "UGC_Recognition": "Yes",
                "NIRF_Rank": 3,
                "Placement_Percentage": 97.8,
                "Student_Count": 9123
            }
        ]
    };
}

function showLoading(show) {
    document.getElementById('loadingUpload').style.display = show ? 'block' : 'none';
}

function showProgress(show) {
    document.getElementById('uploadProgress').style.display = show ? 'block' : 'none';
    if (!show) {
        updateProgress(0);
    }
}

function updateProgress(percent) {
    document.getElementById('uploadProgressBar').style.width = percent + '%';
}

function showValidationResults(data) {
    const panel = document.getElementById('validationPanel');
    const header = document.getElementById('validationHeader');
    const content = document.getElementById('validationContent');
    
    if (data.validation.valid) {
        header.className = 'validation-header';
        header.innerHTML = `
            <h5 class="mb-0">
                <i class="bi bi-check-circle me-2"></i>
                Validation Successful
            </h5>
        `;
        
        content.innerHTML = `
            <div class="success-message">
                <i class="bi bi-check-circle me-2"></i>
                ${data.validation.message}
            </div>
            <p><strong>Records processed:</strong> ${data.records_count}</p>
            <p><strong>Columns found:</strong> ${data.validation.columns_found.length}</p>
        `;
    }
    
    panel.style.display = 'block';
}

function showValidationError(error, details = []) {
    const panel = document.getElementById('validationPanel');
    const header = document.getElementById('validationHeader');
    const content = document.getElementById('validationContent');
    
    header.className = 'validation-header validation-error';
    header.innerHTML = `
        <h5 class="mb-0">
            <i class="bi bi-x-circle me-2"></i>
            Validation Failed
        </h5>
    `;
    
    let detailsHtml = '';
    if (details.length > 0) {
        detailsHtml = `
            <div class="error-list">
                <h6>Issues found:</h6>
                <ul class="mb-0">
                    ${details.map(detail => `<li>${detail}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${error}
        </div>
        ${detailsHtml}
    `;
    
    panel.style.display = 'block';
}

function showDataPreview(preview) {
    // Summary statistics
    const summaryStats = document.getElementById('summaryStats');
    const stats = preview.summary_stats;
    
    summaryStats.innerHTML = `
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon icon-records">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <h4 class="mb-1">${stats.total_records || 0}</h4>
                <p class="text-muted mb-0">Total Records</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon icon-institutions">
                    <i class="bi bi-building"></i>
                </div>
                <h4 class="mb-1">${stats.total_institutions || 0}</h4>
                <p class="text-muted mb-0">Institutions</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon icon-years">
                    <i class="bi bi-calendar-range"></i>
                </div>
                <h4 class="mb-1">${stats.year_range ? `${stats.year_range[0]}-${stats.year_range[1]}` : 'N/A'}</h4>
                <p class="text-muted mb-0">Year Range</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon icon-quality">
                    <i class="bi bi-award"></i>
                </div>
                <h4 class="mb-1">${calculateDataQuality(stats)}%</h4>
                <p class="text-muted mb-0">Data Quality</p>
            </div>
        </div>
    `;
    
    // Preview table
    const table = document.getElementById('previewTable');
    
    // Headers
    const thead = table.querySelector('thead');
    thead.innerHTML = `
        <tr>
            ${preview.columns.map(col => `<th>${col}</th>`).join('')}
        </tr>
    `;
    
    // Data rows
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = preview.sample_data.map(row => 
        `<tr>${preview.columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
    ).join('');
    
    document.getElementById('previewSection').style.display = 'block';
}

function showIntegrationPanel() {
    document.getElementById('integrationPanel').style.display = 'block';
}

async function integrateDataset() {
    if (!tempFilename) {
        alert('No dataset to integrate.');
        return;
    }
    
    try {
        const btn = document.getElementById('integrateBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Integrating...';
        
        const response = await fetch('/api/integrate-dataset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                temp_filename: tempFilename
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Dataset integrated successfully!');
            // Optionally redirect to reports or dashboard
            window.location.href = '/reports';
        } else {
            throw new Error(data.error || 'Integration failed');
        }
        
    } catch (error) {
        console.error('Integration error:', error);
        alert('Integration failed: ' + error.message);
    } finally {
        const btn = document.getElementById('integrateBtn');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-database-add me-2"></i>Integrate Dataset';
    }
}

function downloadSample() {
    // Create sample CSV content
    const sampleData = `College_Name,Year,AICTE_Approval_Score,UGC_Rating,NIRF_Rank,Placement_Percentage,Faculty_Student_Ratio,Research_Projects,Infrastructure_Score,Student_Satisfaction_Score,Final_Performance_Index
"Sample Institute of Technology",2023,85.5,4.2,150,78.5,15.2,25,82.0,88.5,80.5
"Example Engineering College",2023,79.2,3.8,200,72.1,18.5,18,75.5,85.2,76.8`;
    
    const blob = new Blob([sampleData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'sample_dataset_format.csv';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function calculateDataQuality(stats) {
    // Simple quality calculation based on missing values
    if (!stats.missing_values) return 100;
    
    const totalFields = Object.keys(stats.missing_values).length;
    const missingCount = Object.values(stats.missing_values).reduce((sum, count) => sum + count, 0);
    const totalValues = totalFields * (stats.total_records || 1);
    
    return Math.round(((totalValues - missingCount) / totalValues) * 100);
}
</script>
{% endblock %}